---
apiVersion: v1
data:
  tls.crt: QmFnIEF0dHJpYnV0ZXMKICAgIGxvY2FsS2V5SUQ6IDU5IDQ0IERFIDRFIDlEIEM1IDAyIDlBIDExIDcwIDAxIDcwIDc1IEE5IDA3IEMzIDJGIEJGIEFFIDA1IAogICAgZnJpZW5kbHlOYW1lOiBhdGxhc19zZXJ2ZXIKc3ViamVjdD0vQ049YXRsYXNfc2VydmVyL09VPUFpYmVlL089QWliZWUvU1Q9QmVpamluZy9DPUNoaW5hCmlzc3Vlcj0vQ049YWliZWVhcHBfbWlkX2NhCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlFb3pDQ0E0dWdBd0lCQWdJVWJrMTgrMzh3R1UyamgzM0pEQldOeDVnZjlhc3dEUVlKS29aSWh2Y05BUUVMCkJRQXdHakVZTUJZR0ExVUVBd3dQWVdsaVpXVmhjSEJmYldsa1gyTmhNQjRYRFRJd01ETXlNekE0TWpFeU1sb1gKRFRNd01ETXlNVEEzTkRrek4xb3dXVEVWTUJNR0ExVUVBd3dNWVhSc1lYTmZjMlZ5ZG1WeU1RNHdEQVlEVlFRTApEQVZCYVdKbFpURU9NQXdHQTFVRUNnd0ZRV2xpWldVeEVEQU9CZ05WQkFnTUIwSmxhV3BwYm1jeERqQU1CZ05WCkJBWVRCVU5vYVc1aE1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBclJIWU1jbmwKMTNaS25YUEtrOEY5L0VEUE9Wd3JIRFE1TVZpZVowSVNELzBFdHNxeWEvVnN0VmtEaXBWRUxERGYwK3hHa05sVwpaK3BBUWVLNjBUQmhMM0V3TjNYZ2ZQK0ZjVlhXMWh2cVFkMTZzbXRPQ0wwaGVCbWVWMm83RGVlMVR4Nk16WU9ZCmlMZjl6MWNoOEczYkI1VmRvQ0t1N0RES2tMSFNxYUk2bE03ZFhrSzFzbmlZRkltcS9PeWRvTVRvQ3lQaEtmQk4KbVJ5d0I3VTZvcnNpZ01EeWptdUs5MVdYTUh2bENxaWVRM0RkZ2I3N0N5Y3U5OWRGTmRyTFFiOCt0TEhzd3NYRQpITmZwME4yaWhUaHAzSTNjQjR0Y0ptT2J3K1lOdUNONUh6WUR0YVRBczhSMTVTUmZRVjFEQU4xVitEdjJ5ZloyCjkzWDhqK1MxcGlYUDdRSURBUUFCbzRJQm9EQ0NBWnd3REFZRFZSMFRBUUgvQkFJd0FEQWZCZ05WSFNNRUdEQVcKZ0JTcFZIeXFJdkgydmxJdVBrNm5tU01YVEZkMnNUQkNCZ2dyQmdFRkJRY0JBUVEyTURRd01nWUlLd1lCQlFVSApNQUdHSm1oMGRIQnpPaTh2WTJFdGMyVnlkbVZ5TG1GcFltVmxMbU51T2pnME5ETXZaV3BpWTJFdk1CVUdBMVVkCkVRUU9NQXlDQ20wdVlXbGlaV1V1WTI0d0hRWURWUjBsQkJZd0ZBWUlLd1lCQlFVSEF3SUdDQ3NHQVFVRkJ3TUIKTUlIQkJnTlZIUjhFZ2Jrd2diWXdnYk9nZEtCeWhuQm9kSFJ3Y3pvdkwyTmhMWE5sY25abGNpNWhhV0psWlM1agpiam80TkRRekwyVnFZbU5oTDNCMVlteHBZM2RsWWk5M1pXSmthWE4wTDJObGNuUmthWE4wUDJOdFpEMWpjbXdtCmFYTnpkV1Z5UFVOT1BXRnBZbVZsWVhCd1gyMXBaRjlqWVNBc1R6MUJhV0psWlN4RFBVTk9vanVrT1RBM01SZ3cKRmdZRFZRUUREQTloYVdKbFpXRndjRjl0YVdSZlkyRXhEakFNQmdOVkJBb01CVUZwWW1WbE1Rc3dDUVlEVlFRRwpFd0pEVGpBZEJnTlZIUTRFRmdRVVdVVGVUcDNGQXBvUmNBRndkYWtId3krL3JnVXdEZ1lEVlIwUEFRSC9CQVFECkFnWGdNQTBHQ1NxR1NJYjNEUUVCQ3dVQUE0SUJBUUJDdEhPYWpheURDODNhcW1INXRaeSt3TUduUU5aZDFuZHgKa3BLZWdwOWlkeTBWSXgyZmNqOE5NVTRwcFlKcVVCTHFsR2JydnR3VElmTGszbC9pTllvVVpvRjNScXF6bit3cgpUR2tlL3JTUEtTdXQ0MVZxT0taRTl5NW5sN0szWUYraU1ka1lzNkJRRnhtcC9VQ3JBTnJWL0pza3hRSjVtZnZHCjh5bHZQVGtZV0pvUHlMMS9LTUs5disrWGZGTUF4VzVYQnFkUVA4NEcyaE1vUFJ1anNpc1VHNnBMOWNUQkg2OTUKY3NnVm5JWDBSU2RRRFJNeG1rMFg3RU1hSmF5Um1Eejg1UWRpOVFJZTltVzNTYmNyUDQ5a1NVVGpMbEFaTUpSKwp5ZWpaVHdobDRKY0tqNSs3U3RIUzY0aVRNVzZsN2lRZUMvWTlNTlZPNURsd0Y3VFdUcjBUCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.key: QmFnIEF0dHJpYnV0ZXMKICAgIGxvY2FsS2V5SUQ6IDU5IDQ0IERFIDRFIDlEIEM1IDAyIDlBIDExIDcwIDAxIDcwIDc1IEE5IDA3IEMzIDJGIEJGIEFFIDA1IAogICAgZnJpZW5kbHlOYW1lOiBhdGxhc19zZXJ2ZXIKS2V5IEF0dHJpYnV0ZXM6IDxObyBBdHRyaWJ1dGVzPgotLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS0KTUlJRXZBSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS1l3Z2dTaUFnRUFBb0lCQVFDdEVkZ3h5ZVhYZGtxZApjOHFUd1gzOFFNODVYQ3NjTkRreFdKNW5RaElQL1FTMnlySnI5V3kxV1FPS2xVUXNNTi9UN0VhUTJWWm42a0JCCjRyclJNR0V2Y1RBM2RlQjgvNFZ4VmRiV0crcEIzWHF5YTA0SXZTRjRHWjVYYWpzTjU3VlBIb3pOZzVpSXQvM1AKVnlId2Jkc0hsVjJnSXE3c01NcVFzZEtwb2pxVXp0MWVRcld5ZUpnVWlhcjg3SjJneE9nTEkrRXA4RTJaSExBSAp0VHFpdXlLQXdQS09hNHIzVlpjd2UrVUtxSjVEY04yQnZ2c0xKeTczMTBVMTJzdEJ2ejYwc2V6Q3hjUWMxK25RCjNhS0ZPR25jamR3SGkxd21ZNXZENWcyNEkza2ZOZ08xcE1DenhIWGxKRjlCWFVNQTNWWDRPL2JKOW5iM2RmeVAKNUxXbUpjL3RBZ01CQUFFQ2dnRUFFUVljMUlUdUdWd1c2ZGIrZWJ0Q044SnVQOCtybytvVktCLzE4T1ZFWHBNKwpWL2FuUjB4TVphZzhXM0RrVkU1NGJlR2piVk1ibHp3cEZ2SUUrMWU5YjR1OE9QQmM1UjdEVXdzbEIwbVdxT1R1CjBVY1IxWFU1S2hXbkNDVTRhdDA4YmV4czREaE9GRUM0OUNDM2cyMWk2cU9NSXBqV3lQL2hwUXNBMUZQVFhGaTEKYnpvdTdleCt2QXNyMzZ2bXJjdE1jYjBPTStEamhvMUo3dWFHR0MzbkpZZ3VmYUF0dmJqQ2RCV1liVFMzcGVMRQorQVZxUGQ1VEZHUFRzcWdPUjQvdzNnemFHVlA5d0U5Umh6VWpOdlpIMlZ2VG5JaDFUV0FwbnlZbmY2UUUyT1pECld6amxoRWlWemx5ME1ENFRwR010VWl0NS9nTFQ2SVhrR296S2dyRkQxd0tCZ1FEVW5WNlR1dGkvVFVoTUNLdWkKN01UZ01XSmVaNDRkMUQ5Wm1pTXYxUnVHdSttaC9vU0VPbWdBMDdqTmtlc2dSelF2ZldiVjJSclNXWFliQWhhaQpVS1BOR0xTVUNCbjdIS2VlL2VXMnY5THBvM0JoOTFnY0tuZzhTMng0MFNjdDUwSVVOeS8rWUVpTUh5bVVVRmJsCmZKSE5nVVJ4N2lzRVFLcTR5cjhJc2RqZUR3S0JnUURRWXJYeEtGcDI3WUJSSHZQZGxqeTljeDhpQmxpWm4wNFAKS0lPUlRFTng3M3BvcDUrU0lSU1R1a3p1QlZBbkExbENCNm95MkZGTmp6dTd1YjRnVnZCQ3BwK2tOcXFoWUdnaQpEeW9aZVp0NTdGMmh3cTQrTHd5aG95eDB3NVVCT0MvUGJYTVU2emV2Y0hYcWlMdGxCZzg1RVZWWnlyN3NIakRYCmRadjVRck11UXdLQmdBZVZ2YVFEakd2MnM5ZVNqNXoyV1dldUcxWkcxM2tVODFXYy9CaGV2K2FrbVljZjcxWlEKUnhtUWRBMVJZVlA3ZGs4amFDSEU1d0lPRXZxUHJvTUg0WEFWcTR1RVpuamc0dEgzT05TMkx5NEttSjNHRnl5YQpEMFFIWk0xQ21PVTRWTkVuenR5Q1R0UkE0RmpjTE4xdS9qeVltZnAraHFaV01FRDdhcWxDdnZ2ZEFvR0FHOWdrCndZMkgwUDVaTi8ydnpqc0Y4TGFTUVdTaHNCMUdPK1pJOWtBL2Z0amwvVmZ3allFWUU4bEFBRW43ZE1zUXdTN3YKQWc0L2h1S05zNzdVOWROSUZVL1lZd1BlOXVNLzV0VXA1ZStHNDlxK2hCL1VVb0RNNmtnNFozMit5a1BzdDRYRAphOWNtUUs0QlE0NXpvOE1VZzZhYVJmNCtWcVNPR0N3aDVFT1NWNnNDZ1lBU010cktsaWh5NmgwQWxaTmtjQjVxCk5SOUFiNm8rMEFUVHdsbldwdW5nQ1RQWFBPczJvZVc4UUlnTnVVWEdyNGxxWTBsbXpvcE9xdEZTR2E1TTZoN2cKY0FmMG9RR1Y0YXBraGJYTzN6MHFycndlNHlOS0tSZ1JSa2N4eDE4Q29HdFlaTzVVZWxtZTJsejVFVFFyNzQragpjSHgzRDZPM1ZXYys3UnhCV2V5eVlBPT0KLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLQo=
  ca.crt: U3ViamVjdDogQ049YWliZWVfcm9vdCxPVT1BaWJlZSxPPUFpYmVlLFNUPUJlaWppbmcsQz1DTgpJc3N1ZXI6IENOPWFpYmVlX3Jvb3QsT1U9QWliZWUsTz1BaWJlZSxTVD1CZWlqaW5nLEM9Q04KLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR4ekNDQXErZ0F3SUJBZ0lVS0d6cUlYTXRVT0ZRTVZzbjg5RGZTNW1sL1FRd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1ZERVRNQkVHQTFVRUF3d0tZV2xpWldWZmNtOXZkREVPTUF3R0ExVUVDd3dGUVdsaVpXVXhEakFNQmdOVgpCQW9NQlVGcFltVmxNUkF3RGdZRFZRUUlEQWRDWldscWFXNW5NUXN3Q1FZRFZRUUdFd0pEVGpBZUZ3MHhPVEV3Ck1UZ3dNelU0TkRsYUZ3MHpPVEV3TVRNd016VTRORGxhTUZReEV6QVJCZ05WQkFNTUNtRnBZbVZsWDNKdmIzUXgKRGpBTUJnTlZCQXNNQlVGcFltVmxNUTR3REFZRFZRUUtEQVZCYVdKbFpURVFNQTRHQTFVRUNBd0hRbVZwYW1sdQpaekVMTUFrR0ExVUVCaE1DUTA0d2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUURRCm5uQVBkTVlMZXBCdzF1Z3VXVm9OOTlJZ3pKQlhLVEFnK1p5T1VaY2hKcFpZaUxDWnl1QUdibVVKcnM1OUkxMW0KSy9ZOEQyL21RVEI5SHJUNW4vMFc0QjdPaTN0Uzd0M1JRR1N6bFFRWG94cEFOWkVqR2NNQy9FK2RpOWNYbjFrZQplUjFzT2NCUW5SelVuSEVjZDFxc1BRWGMwUGhmVkE2MkNRUzRKME4wN3YwekVoNExDNU9PVTU3eHc3VlBVejRtCklXdUVReW5idnZrVVN2V2hTZElxLzVMUDlwTjJuTk1nL2tpQnl1WFJxNndoSzdXVjVGNEo4WVZ4YnkrV3puQ1EKY3NEOHE3V29hYTZ3dUFleWZDRG0zS1dVbHY2c0dsNHYySXFyVDBvMUR2VklRd0ZJdXVEZE92ZFpvZDltSmdqVgpUQ3orVllRVjJIVWMvRzhJRHdFREFnTUJBQUdqZ1pBd2dZMHdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QWZCZ05WCkhTTUVHREFXZ0JRUEJnVUw5YXJvL1I3aHhPa0tVdDBRWU1yLzBEQVVCZ05WSFJJRURUQUxnZ2txWVdsaVpXVXUKWTI0d0ZBWURWUjBSQkEwd0M0SUpLbUZwWW1WbExtTnVNQjBHQTFVZERnUVdCQlFQQmdVTDlhcm8vUjdoeE9rSwpVdDBRWU1yLzBEQU9CZ05WSFE4QkFmOEVCQU1DQVlZd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFKNEs2ZVVGCk5NV2NGUm5FcmFpT2duMG9xRHVubWQ2Vi9SN0lMUk4rQkFBRFMydzlJcjNhNnEybk1FUVkxRFdnM1ppeHQ0ZkEKUk9QS1J1ZWlRQm91NHljWTY0by9iclc2NmZWazBuRHJ6NUFzdjZIRkUwcDd1TW5zTzJCbnh0KzZHa0NTczhyMwo1OGdEU0c2OG55QmhISkN5cGhqWWI0YkFWSnp1NzAvbTZ2eWNxaTFjb2RFVFB1aTRURkxIWVU2L2xpcGJtV1hrCnpCdVh5RzlOMTBBU0ZzN3hMRklLbWlCSUtwcFJHQlkxZHM5V0ZCUVhRZmxHUlBnRlNXTVUzWEFUOUE1N0xuV1kKcGluMFZWZVdDeWdiZHpuSlVVaGxDczhyUzJFc2pmMFlwYnNseXRycTVJNzNUd241cXlmVk5ublpKVXNWUk9MMwp2TVpLYlNDYld0ais4eXc9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KU3ViamVjdDogQ049YWliZWVhcHBfbWlkX2NhCklzc3VlcjogQ049YWliZWVfcm9vdCxPVT1BaWJlZSxPPUFpYmVlLFNUPUJlaWppbmcsQz1DTgotLS0tLUJFR0lOIENFUlRJRklDQVRFLS0tLS0KTUlJRHl6Q0NBck9nQXdJQkFnSVVCM3Q1bHBFemRWUEhYN3BPbExkK21zSlFsYTh3RFFZSktvWklodmNOQVFFTApCUUF3VkRFVE1CRUdBMVVFQXd3S1lXbGlaV1ZmY205dmRERU9NQXdHQTFVRUN3d0ZRV2xpWldVeERqQU1CZ05WCkJBb01CVUZwWW1WbE1SQXdEZ1lEVlFRSURBZENaV2xxYVc1bk1Rc3dDUVlEVlFRR0V3SkRUakFlRncweU1EQXoKTWpNd056UTVNemRhRncwek1EQXpNakV3TnpRNU16ZGFNQm94R0RBV0JnTlZCQU1NRDJGcFltVmxZWEJ3WDIxcApaRjlqWVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBSjk5RWNjVkNPUzY4UzJ5CiswZnlwUTVnWVo1OEJPZTF2aUw1UW9FU05oMGZTM2c4d0lWbTFncFpqM1h5RWwrM2YxZDhrL21RRldoOUxHNFUKSDVPc2YzaDEyRFppcURpbmZYSzE2VEluMjlRVW93bEdxU2F4Ty9vWDh0VUdBdkdMYStHcm9ub0xhS2FTWHdHOQprby9qL3FGUk52S2NjUElBUGcreW9NNTNteE0vakVIRlIwNERRTGR4MTZ3NEtuWnJFamNncExCZlIwalg1MGJzCk9OZFErd2JEYVhqTlZSTU1Zd2NnYmVocGRVaXB6bExQK3JQbUdGdHgwSktRdXF3V1BIR2lDNXQ1VjBubEJtb3EKUVMxclRxbDE4c2lyeEdDTEMvSU5xUFFUTjlTZnFWa3pNZ1Z2blFRSjk2a2k2V1BGZjZqRFNTTVlFMGhLbzlzaApSbW9wUTFzQ0F3RUFBYU9CempDQnl6QVBCZ05WSFJNQkFmOEVCVEFEQVFIL01COEdBMVVkSXdRWU1CYUFGQThHCkJRdjFxdWo5SHVIRTZRcFMzUkJneXYvUU1FRUdDQ3NHQVFVRkJ3RUJCRFV3TXpBeEJnZ3JCZ0VGQlFjd0FZWWwKYUhSMGNITTZMeTlqWVMxelpYSjJaWEl1WVdsaVpXVXVZMjQ2T0RRME15OWxhbUpqWVRBVUJnTlZIUklFRFRBTApnZ2txWVdsaVpXVXVZMjR3RHdZRFZSMGxCQWd3QmdZRVZSMGxBREFkQmdOVkhRNEVGZ1FVcVZSOHFpTHg5cjVTCkxqNU9wNWtqRjB4WGRyRXdEZ1lEVlIwUEFRSC9CQVFEQWdHR01BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQTIKZEMxZGxRcm5PT1NUTUEyQ3VlcTEwYmlZTUJGdmlEMlBCZ3lSWGc2S2Z3WUhydkhIZW1yeEtFWXhIdFBucWJJeQpKRERDUzlnZHN0RzJVaE5jcmdQZlpsYWk1dHhIOXIxQ3ZRU3UvY01NNlhxaTVFdVM1MmNTRUYrR0daSEVCNisyCmhNVGdTOFcwR0p1UWM5YmZKWE5SRDJ2bkZ0eDFab2VIRTlUMDROUmhjMm9jNzRjeFVQS3NXRWpadUhYd1dvNmIKOWV4V2pYYnYwbjVTL25JRDBsT2hpUVhTdWdKc1U3R1FRU0c2NU5qZDlJWUExT2ZyK0dQaTFySjlxZlJuME55UwpQUS9TUDFqTWxMNXdsVVgyb0FCYTMzWVpsZ1NINkNSck9JQStzZnVDYUdHU3dyMjNucUV3Wi8rOVlGT0xqQWcyCkc1Q2tjODJnMVU1U2NnbEM2d0FYCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
kind: Secret
metadata:
  name: deploy-manager-tls-secret
  namespace: manage
type: kubernetes.io/tls

---
apiVersion: v1
kind: Service
metadata:
  name: deploy-manager
  namespace: manage
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "50090"
spec:
  ports:
    - name: http
      port: 8080
      protocol: TCP
      targetPort: 50080
      nodePort: 32280
    - name: metric
      port: 8090
      protocol: TCP
      targetPort: 50090
      nodePort: 32290
    - name: grpc
      port: 5070
      protocol: TCP
      targetPort: 50070
      nodePort: 32270
  selector:
    app: deploy-manager
  sessionAffinity: None
  type: NodePort

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: deploy-manager-config
  namespace: manage
data:
  db.yaml: |
    dbType: mysql
    username: root
    password: root
    host: 172.20.10.244
    port: 3306
    schema: deploy_manager
    params:
      charset: utf8mb4
      parseTime: True
      loc: Local
    autoMigrate: true
    logMode: true

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-manager
  namespace: manage
  labels:
    app: deploy-manager
spec:
  replicas: 1
  selector:
    matchLabels:
      app: deploy-manager
  template:
    metadata:
      labels:
        app: deploy-manager
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: manage
                    operator: In
                    values:
                      - "true"
      containers:
        - name: deploy-manager
          image: platform/deploy-manager:53f8b7d
          imagePullPolicy: Always
          command:
            - /usr/local/bin/deploy-manager
            - --key=/etc/galaxy/pki/manager/tls.key
            - --cert=/etc/galaxy/pki/manager/tls.crt
            - --ca=/etc/galaxy/pki/manager/ca.crt
            - --db=/etc/galaxy/config/db.yaml
            - --auth-addr=http://172.16.244.6:30099
            - --auth-client-id=68
            - --auth-client-secret=bl-hezU8XyUw4uu-ut4ezw
            - --auth-skip=false
            - --web-insecure
            - --v=10
          resources:
            limits:
              cpu: 500m
              memory: 200Mi
            requests:
              cpu: 500m
              memory: 200Mi
          volumeMounts:
            - name: pki-volume
              mountPath: /etc/galaxy/pki/manager
            - name: cfg-volume
              mountPath: /etc/galaxy/config
      hostAliases:
        - ip: "172.20.10.218"
          hostnames:
            - "code.xxxxx.cn"
        - ip: "172.16.21.13"
          hostnames:
            - "registry.xxxxx.cn"
      volumes:
        - name: cfg-volume
          configMap:
            name: deploy-manager-config
            items:
              - key: db.yaml
                path: db.yaml
        - name: pki-volume
          secret:
            secretName: deploy-manager-tls-secret
